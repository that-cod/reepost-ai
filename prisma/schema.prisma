generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector(schema: "public")]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Analytics {
  id             String         @id
  userId         String
  postId         String?
  createdAt      DateTime       @default(now())
  eventType      AnalyticsEvent
  likes          Int            @default(0)
  comments       Int            @default(0)
  shares         Int            @default(0)
  views          Int            @default(0)
  clicks         Int            @default(0)
  engagementRate Float          @default(0)
  date           DateTime       @db.Date
  Post           Post?          @relation(fields: [postId], references: [id])
  User           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([eventType])
  @@index([postId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model AuditLog {
  id         String   @id
  userId     String?
  action     String
  resource   String
  resourceId String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([action])
  @@index([createdAt])
  @@index([resource])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Post {
  id             String                 @id
  userId         String
  content        String
  createdAt      DateTime               @default(now())
  updatedAt      DateTime
  topic          String?
  tone           Tone                   @default(PROFESSIONAL)
  intensity      Intensity              @default(MEDIUM)
  aiModel        String?
  generatedFrom  String?
  embeddingModel String?
  embedding      Unsupported("vector")?
  status         PostStatus             @default(DRAFT)
  scheduledFor   DateTime?
  publishedAt    DateTime?
  linkedInPostId String?
  likes          Int                    @default(0)
  comments       Int                    @default(0)
  shares         Int                    @default(0)
  views          Int                    @default(0)
  mediaUrls      String[]
  Analytics      Analytics[]
  User           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  SavedPost      SavedPost[]

  @@index([createdAt])
  @@index([publishedAt])
  @@index([scheduledFor])
  @@index([status])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model SavedPost {
  id      String   @id
  userId  String
  postId  String
  savedAt DateTime @default(now())
  Post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  User    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model SavedTopic {
  id        String   @id @default(cuid())
  userId    String
  topic     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Settings {
  id                      String    @id
  userId                  String    @unique
  createdAt               DateTime  @default(now())
  updatedAt               DateTime
  autoPublish             Boolean   @default(false)
  defaultScheduleTime     String    @default("09:00")
  preferredAiProvider     String    @default("openai")
  defaultTone             Tone      @default(PROFESSIONAL)
  defaultIntensity        Intensity @default(MEDIUM)
  emailNotifications      Boolean   @default(true)
  publishNotifications    Boolean   @default(true)
  engagementNotifications Boolean   @default(true)
  autoSyncEngagement      Boolean   @default(true)
  syncFrequency           Int       @default(60)
  aiToneText              String?
  avoidControversial      Boolean   @default(true)
  contentLength           String    @default("medium")
  emojiUsage              String    @default("moderate")
  hashtagCount            String    @default("3-5")
  includeCTA              Boolean   @default(false)
  jobDescriptions         String[]  @default([])
  professionalLanguage    Boolean   @default(true)
  timezone                String    @default("America/New_York")
  User                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Subscription {
  id                   String             @id
  userId               String
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  stripeSubscriptionId String             @unique
  stripePriceId        String
  stripeCustomerId     String
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  plan                 Plan
  User                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Usage {
  id             String   @id
  userId         String
  createdAt      DateTime @default(now())
  month          DateTime @db.Date
  postsGenerated Int      @default(0)
  postsPublished Int      @default(0)
  aiCallsMade    Int      @default(0)
  storageUsedMb  Int      @default(0)

  @@unique([userId, month])
  @@index([month])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model User {
  id                     String         @id
  name                   String?
  email                  String?        @unique
  emailVerified          DateTime?
  image                  String?
  password               String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime
  linkedInId             String?        @unique
  linkedInUsername       String?
  linkedInUrn            String?
  stripeCustomerId       String?        @unique
  stripeSubscriptionId   String?        @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  plan                   Plan           @default(FREE)
  defaultTone            Tone           @default(PROFESSIONAL)
  defaultIntensity       Intensity      @default(MEDIUM)
  linkedInProfileUrl     String?
  Account                Account[]
  Analytics              Analytics[]
  Post                   Post[]
  SavedPost              SavedPost[]
  SavedTopic             SavedTopic[]
  Session                Session[]
  Settings               Settings?
  Subscription           Subscription[]
  FollowedCreator        FollowedCreator[]

  @@index([email])
  @@index([linkedInId])
  @@index([stripeCustomerId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model generation_logs {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  topic              String
  tone               String?
  category           String?
  generated_post     String
  reference_post_ids String[]
  avg_similarity     Float?    @db.Real
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model viral_posts {
  id                    String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  post_id               String                 @unique @db.VarChar(255)
  content               String
  embedding             Unsupported("vector")?
  author_name           String?                @db.VarChar(255)
  author_profile_url    String?
  author_follower_count Int?
  likes                 Int?                   @default(0)
  comments              Int?                   @default(0)
  reposts               Int?                   @default(0)
  engagement_score      Int?                   @default(0)
  tone_detected         String?                @db.VarChar(50)
  topic_category        String?                @db.VarChar(100)
  posted_date           DateTime?              @db.Timestamptz(6)
  post_url              String?
  created_at            DateTime?              @default(now()) @db.Timestamptz(6)

  @@index([engagement_score(sort: Desc)], map: "idx_engagement")
  @@index([tone_detected], map: "idx_tone")
}

enum AnalyticsEvent {
  POST_CREATED
  POST_PUBLISHED
  POST_ENGAGEMENT
  POST_VIEWED
  POST_CLICKED
}

enum Intensity {
  LOW
  MEDIUM
  HIGH
  EXTREME
}

enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
  ARCHIVED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  TRIALING
  UNPAID
}

enum Tone {
  PROFESSIONAL
  CASUAL
  ENTHUSIASTIC
  THOUGHTFUL
  BOLD
  INSPIRATIONAL
  EDUCATIONAL
  HUMOROUS
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  NONE
}

// ============================================================================
// TRENDING CREATORS & POSTS
// ============================================================================

model TrendingCreator {
  id             String         @id @default(cuid())
  name           String
  username       String?        // LinkedIn username
  headline       String?        @db.Text // Professional headline
  image          String?
  bio            String?        @db.Text
  occupation     String?
  location       String?
  industry       String?
  linkedinUrl    String?        @unique // LinkedIn profile URL
  followerCount  Int            @default(0)
  isFollowing    Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  // Relationships
  trendingPosts   TrendingPost[]
  followedBy      FollowedCreator[]

  @@index([followerCount])
  @@index([name])
  @@index([linkedinUrl])
  @@index([username])
}

model TrendingPost {
  id                String          @id @default(cuid())
  creatorId         String
  content           String          @db.Text
  
  // LinkedIn metadata
  linkedInPostId   String?         @unique // Original LinkedIn post ID
  postUrl           String?         // Full LinkedIn post URL
  postType          String?         // regular, repost, quote
  
  // Media
  mediaUrl          String?
  mediaType         MediaType       @default(NONE)
  
  // Engagement metrics
  likes             Int             @default(0)
  comments          Int             @default(0)
  reposts           Int             @default(0)
  views             Int             @default(0)
  
  // Outlier index (1-100 scale, measures virality)
  outlierIndex      Int             @default(50)
  
  // Content analysis
  wordCount         Int?
  hasQuestion       Boolean?
  hasCallToAction   Boolean?
  
  // Timing analysis
  postedHour        Int?            // 0-23
  postedDayOfWeek   String?         // Monday, Tuesday, etc.
  
  // Metadata
  publishedDate     DateTime        @default(now())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Keywords/hashtags for filtering
  keywords          String[]        @default([])
  
  // Relationships
  creator           TrendingCreator @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  @@index([creatorId])
  @@index([publishedDate])
  @@index([outlierIndex])
  @@index([likes])
  @@index([comments])
  @@index([reposts])
  @@index([mediaType])
  @@index([linkedInPostId])
  @@index([postedDayOfWeek])
  @@index([hasQuestion])
  @@index([hasCallToAction])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model FollowedCreator {
  id        String   @id @default(cuid())
  userId    String
  creatorId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  Creator TrendingCreator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId])
  @@index([creatorId])
}
